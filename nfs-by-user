#!/usr/bin/env python3

import sys
import argparse
import pandas as pd

def main():
    parser = argparse.ArgumentParser(description=
        'Get NFS usage by user from CSV data generated by nfsio. \
        Usage is calculated as the average use by that user since \
        the drive was mounted and summed up across nodes.')
    parser.add_argument('-d', '--device', type=str, help='Check usage on a particular disk array.')
    parser.add_argument('-p', '--human-readable', default=False, const=True, action='store_const', 
        help='Print in human readable format. Otherwise will print to csv.')
    parser.add_argument('csv', type=str, help='CSV file to be read.')
    argv = parser.parse_args()

    nfs = pd.read_csv(argv.csv)
    if argv.device is not None:
        nfs = nfs[nfs['device'] == argv.device[0]]
    byuser = nfs.groupby('user').sum()
    byuser = byuser.sort('wkB_s', ascending=False)

    if argv.human_readable:
        print(byuser)
    else:
        byuser.to_csv(sys.stdout)


if __name__ == '__main__':
    main()
